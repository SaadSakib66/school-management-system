name: Mirror to barabd (token_barabd)

on:
  push:
    branches: ['**']      # শুধু main মিরর করতে চাইলে: ['main']
  workflow_dispatch: {}   # চাইলে ম্যানুয়ালি রান করতে পারবেন

concurrency:
  group: mirror-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # প্রথম রানে সব ব্রাঞ্চ/ট্যাগ এনে নিন
      - name: সব ব্রাঞ্চ/ট্যাগ ফেচ
        run: |
          git remote set-branches --add origin '*'
          git fetch --all --tags --prune

      # টোকেন দিয়ে টার্গেট প্রাইভেট রেপো দেখা যায় কি না আগে যাচাই
      - name: টোকেন ভেরিফাই (API)
        env:
          MIRROR_TOKEN: ${{ secrets.token_barabd }}
        run: |
          set -e
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${MIRROR_TOKEN}" \
            https://api.github.com/repos/barabd/school-management-system)
          echo "GitHub API HTTP $code"
          test "$code" = "200"

      # মিরর রিমোট যোগ/আপডেট — Classic PAT-ফ্রেন্ডলি URL
      - name: মিরর রিমোট কনফিগার (idempotent)
        env:
          MIRROR_TOKEN: ${{ secrets.token_barabd }}
        run: |
          set -e
          git config --global user.email "mirror-bot@users.noreply.github.com"
          git config --global user.name  "Mirror Bot"

          # Classic PAT হলে এই ফরম্যাট সবচেয়ে নির্ভরযোগ্য:
          #   https://<username>:<token>@github.com/<owner>/<repo>.git
          URL="https://barabd:${MIRROR_TOKEN}@github.com/barabd/school-management-system.git"

          if git remote get-url mirror >/dev/null 2>&1; then
            git remote set-url mirror "$URL"
          else
            git remote add mirror "$URL"
          fi

          git remote -v
          # খালি রেপো হলে আউটপুট ফাঁকা হতে পারে; ফেল করাবেন না
          git ls-remote --heads mirror || true

      # নিরাপদ সিঙ্ক — টার্গেটে কিছু ডিলিট করে না
      - name: ব্রাঞ্চ পুশ
        run: git push mirror --all

      - name: ট্যাগ পুশ
        run: git push mirror --tags

      # একদম হুবহু মিরর (ডিলিটসহ) চাইলে উপরের দুই স্টেপের বদলে এটা ব্যবহার করুন:
      # - name: Strict mirror (সতর্কতা)
      #   run: git push --mirror mirror
